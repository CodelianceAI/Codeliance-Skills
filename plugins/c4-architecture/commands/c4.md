---
description: Analyse a codebase and generate a C4 architecture model in Structurizr DSL
---

# C4 Architecture Modelling

Analyse the current project and generate a complete C4 architecture model in Structurizr DSL. The primary output is `architecture/workspace.dsl` — a diffable, version-controlled source of truth for the system's architecture.

## Steps

### 1. Analyse the codebase

Scan the project to understand its architecture:

- **Build and config files** — read `package.json`, `pom.xml`, `build.gradle`, `go.mod`, `Cargo.toml`, `docker-compose.yml`, Kubernetes manifests, Terraform files, `.env.example`, and similar to understand the technology stack.
- **Actors and external dependencies** — who uses the system? What third-party services does it call (CDNs, payment processors, notification providers, etc.)?
- **Containers** — what are the separately deployable units? Backend services, frontends, data stores, caches, message brokers, object storage.
- **Components** — within each service, what are the logical groupings? Look at the source tree for HTTP handlers, domain/business-logic layers, data-access modules, third-party API wrappers, middleware, and event consumers.
- **Connections** — how do these pieces talk to each other? Trace HTTP/gRPC/GraphQL calls, database queries, pub/sub channels, external API usage, and user-facing endpoints.

### 2. Clarify with the user (if needed)

Before generating the model, ask the user about anything that cannot be determined from the code alone:

- What the system is called and what problem it solves
- Any third-party services or internal systems that aren't obvious from the code
- Whether deployment diagrams are wanted, and for which environments

Keep this brief. If the codebase is clear enough, proceed directly to generation.

### 3. Write `architecture/workspace.dsl`

Generate the Structurizr DSL workspace file. Follow the full C4 hierarchy:

- **People** (actors) who interact with the system
- **Software Systems** — the primary system and any external systems
- **Containers** within the primary system (services, databases, queues, frontends)
- **Components** within each container (handlers, services, repositories, clients, middleware)

Modelling rules:

- Cover all 3 C4 levels: System Context, Container, and Component.
- Every relationship needs a description and technology label, defined at each level — system, container, and component.
- Apply **semantic tags**: `"Database"` on databases, `"External"` on external systems, `"Queue"` on message queues. Tags convey meaning, not appearance.
- Create views: one `systemContext` view, one `container` view, and one `component` view per container that has components.
- Use `autoLayout` on all views.
- Do NOT include a `styles` section. The DSL should be content-only — C4-PlantUML provides sensible defaults.

**Reference the bundled DSL specification and example** (located in this skill's `references/` and `examples/` directories).

### 4. Update `.gitignore`

Check the project's `.gitignore` file. If `architecture/.diagrams/` is not already listed, add it. The rendered output directory should not be committed.

### 5. Validate (if structurizr-cli is installed)

Check whether `structurizr-cli` is available:

```bash
which structurizr-cli
```

If installed, validate the generated DSL:

```bash
structurizr-cli validate -workspace architecture/workspace.dsl
```

If validation fails, read the error output, fix the DSL, and retry. Attempt up to 3 fix-and-validate cycles.

If `structurizr-cli` is not installed, skip validation and mention that the user can install it with `brew install structurizr-cli` to enable validation.

### 6. Offer to render images

After generating the DSL, ask the user if they would like rendered diagram images (PNG or SVG).

If yes, check for the required tools:

```bash
which structurizr-cli && which plantuml
```

If both are available, render:

```bash
structurizr-cli export -workspace architecture/workspace.dsl -format plantuml/c4plantuml -output architecture/.diagrams
plantuml -tpng architecture/.diagrams/*.puml
```

If the tools are not installed, tell the user how to install them:

```bash
brew install structurizr-cli plantuml
```

Do not block the workflow. The DSL file is the primary deliverable — rendering is optional.

## Output

After running this command, the project will contain:

- `architecture/workspace.dsl` — the C4 model in Structurizr DSL, committed to version control
- `architecture/.diagrams/` — rendered PNG/SVG images (gitignored), only if the user requested rendering
- `.gitignore` updated with `architecture/.diagrams/` if it wasn't already there
