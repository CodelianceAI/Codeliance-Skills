---
description: Analyse a codebase and generate a C4 architecture model in Structurizr DSL
argument-hint: [update|full]
---

Analyse the current project and generate a C4 architecture model by following the c4-architecture skill instructions. The primary output is `architecture/workspace.dsl`.

**Modes:**

- **`/c4`** or **`/c4 full`** — scan the entire codebase and generate a complete workspace from scratch.
- **`/c4 update`** — read the existing `architecture/workspace.dsl`, diff against the current codebase, and update only what changed.

**Rendering:** After generating the DSL, offer to render SVG diagrams with drill-down links (clicking a system opens its containers, clicking a container opens its components):

```bash
tmpdir=$(mktemp -d)
trap 'rm -rf "$tmpdir"' EXIT

# Export and strip prefix
structurizr-cli export -workspace architecture/workspace.dsl -format plantuml/c4plantuml -output "$tmpdir"
for f in "$tmpdir"/structurizr-*.puml; do mv "$f" "$tmpdir/$(basename "$f" | sed 's/^structurizr-//')"; done

# Build link map: scan boundaries to find drill-down targets
link_map="$tmpdir/_link_map.txt"
: > "$link_map"
for f in "$tmpdir"/*.puml; do
  [ -f "$f" ] || continue
  svg_name="$(basename "$f" .puml).svg"
  cb_id=$(sed -n 's/.*Container_Boundary("\([^"]*\)_boundary".*/\1/p' "$f" | head -1)
  if [ -n "$cb_id" ]; then echo "Container ${cb_id} ${svg_name}" >> "$link_map"; continue; fi
  sb_id=$(sed -n 's/.*System_Boundary("\([^"]*\)_boundary".*/\1/p' "$f" | head -1)
  if [ -n "$sb_id" ]; then echo "System ${sb_id} ${svg_name}" >> "$link_map"; fi
done

# Inject $link values
while IFS=' ' read -r elem_type elem_id svg_name; do
  escaped_id=$(echo "$elem_id" | sed 's/\./\\./g')
  for f in "$tmpdir"/*.puml; do
    [ -f "$f" ] || continue
    sed '/'"${elem_type}"'('"${escaped_id}"',/s/\$link=""/\$link="'"${svg_name}"'"/' "$f" > "$f.tmp" && mv "$f.tmp" "$f"
  done
done < "$link_map"

# Render SVGs
mkdir -p architecture/.diagrams
plantuml -tsvg -o "$(cd architecture/.diagrams && pwd)" "$tmpdir"/*.puml
```

Requires `structurizr-cli` and `plantuml` (`brew install structurizr-cli plantuml`).
